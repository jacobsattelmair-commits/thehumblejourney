<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thoughts — The Humble Journey</title>
  <meta name="description" content="Writing by Jacob Sattelmair.">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="nav">
    <div class="nav__inner">
      <a href="index.html" class="nav__name">The Humble Journey</a>
      <button class="nav__toggle" id="navToggle" aria-expanded="false" aria-label="Toggle menu">
        <span></span><span></span><span></span>
      </button>
      <ul class="nav__links" id="navLinks">
        <li><a href="index.html">Home</a></li>
        <li><a href="thoughts.html" class="active">Thoughts</a></li>
        <li><a href="bio.html">Bio</a></li>
        <li><a href="photos.html">Photos</a></li>
      </ul>
    </div>
  </nav>

  <main>
    <section class="page-header">
      <div class="container">
        <span class="label">Thoughts</span>
      </div>
    </section>

    <section class="posts">
      <div class="container">
        <div class="posts__list" id="postsList">
          <div class="posts__empty" id="loadingMsg"><p>Loading posts…</p></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Single post view (hidden by default) -->
  <div id="postView" style="display:none;">
    <section class="page-header">
      <div class="container">
        <a href="thoughts.html" class="back-link">&larr; All thoughts</a>
        <h1 id="postTitle"></h1>
        <p class="post-date" id="postDate"></p>
      </div>
    </section>
    <section class="post-body">
      <div class="container container--narrow">
        <div id="postContent"></div>
      </div>
    </section>
  </div>

  <footer>
    <div class="container">
      <p>&copy; 2025 Jacob Sattelmair &mdash; thehumblejourney.com</p>
    </div>
  </footer>

  <script src="main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", function(user) {
        if (!user) {
          window.netlifyIdentity.on("login", function() {
            document.location.href = "/admin/";
          });
        }
      });
    }

    // --- Parse frontmatter from markdown ---
    function parseFrontmatter(text) {
      const match = text.match(/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/);
      if (!match) return { data: {}, content: text };
      const data = {};
      match[1].split('\n').forEach(line => {
        const colonIdx = line.indexOf(':');
        if (colonIdx === -1) return;
        const key = line.slice(0, colonIdx).trim();
        const val = line.slice(colonIdx + 1).trim().replace(/^"|"$/g, '');
        data[key] = val;
      });
      return { data, content: match[2] };
    }

    // --- Format date nicely ---
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr + 'T12:00:00');
      return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // --- Fetch list of post files from GitHub ---
    const REPO = 'jacobsattelmair-commits/thehumblejourney';
    const POSTS_PATH = 'thehumblejourney-site/posts';
    const RAW_BASE = 'https://raw.githubusercontent.com/' + REPO + '/main/' + POSTS_PATH + '/';
    const API_BASE = 'https://api.github.com/repos/' + REPO + '/contents/' + POSTS_PATH;

    async function loadPosts() {
      const list = document.getElementById('postsList');
      try {
        const res = await fetch(API_BASE);
        if (!res.ok) throw new Error('Could not fetch posts');
        const files = await res.json();
        const mdFiles = files.filter(f => f.name.endsWith('.md')).reverse(); // newest first

        if (mdFiles.length === 0) {
          list.innerHTML = '<div class="posts__empty"><p>No posts yet.</p></div>';
          return;
        }

        // Fetch all post contents in parallel
        const posts = await Promise.all(mdFiles.map(async f => {
          const r = await fetch(RAW_BASE + f.name);
          const text = await r.text();
          const { data, content } = parseFrontmatter(text);
          return { filename: f.name, data, content };
        }));

        // Check if we're viewing a specific post (via hash)
        const hash = window.location.hash.slice(1);
        if (hash) {
          const post = posts.find(p => p.filename === decodeURIComponent(hash));
          if (post) { showPost(post); return; }
        }

        // Generate a plain-text preview from post body
        function getPreview(content) {
          // Strip markdown syntax and get first ~300 chars
          const plain = content
            .replace(/^#+\s+.*/gm, '')        // remove headings
            .replace(/!\[.*?\]\(.*?\)/g, '')   // remove images
            .replace(/\[([^\]]+)\]\(.*?\)/g, '$1') // links -> text
            .replace(/[*_`~]/g, '')            // remove emphasis chars
            .replace(/\n{2,}/g, ' ')           // collapse paragraphs
            .replace(/\n/g, ' ')               // collapse line breaks
            .trim();
          return plain.length > 280 ? plain.slice(0, 280).replace(/\s\S+$/, '') + '…' : plain;
        }

        // Render list
        list.innerHTML = posts.map(p => `
          <article class="post-entry">
            <h2 class="post-entry__title">
              <a href="#${encodeURIComponent(p.filename)}">${p.data.title || 'Untitled'}</a>
            </h2>
            <p class="post-entry__date">${formatDate(p.data.date)}</p>
            <p class="post-entry__excerpt">${p.data.excerpt || getPreview(p.content)}</p>
          </article>
        `).join('');

        // Handle clicking a post
        list.querySelectorAll('a[href^="#"]').forEach(a => {
          a.addEventListener('click', async e => {
            e.preventDefault();
            const filename = decodeURIComponent(a.getAttribute('href').slice(1));
            const post = posts.find(p => p.filename === filename);
            if (post) {
              history.pushState(null, '', '#' + encodeURIComponent(filename));
              showPost(post);
            }
          });
        });

      } catch (err) {
        list.innerHTML = '<div class="posts__empty"><p>Could not load posts right now.</p></div>';
        console.error(err);
      }
    }

    function showPost(post) {
      document.querySelector('main > section.page-header').style.display = 'none';
      document.querySelector('section.posts').style.display = 'none';
      const view = document.getElementById('postView');
      document.getElementById('postTitle').textContent = post.data.title || 'Untitled';
      document.getElementById('postDate').textContent = formatDate(post.data.date);
      document.getElementById('postContent').innerHTML = marked.parse(post.content);
      view.style.display = '';
    }

    // Handle back navigation
    window.addEventListener('popstate', () => {
      if (!window.location.hash) {
        document.getElementById('postView').style.display = 'none';
        document.querySelector('main > section.page-header').style.display = '';
        document.querySelector('section.posts').style.display = '';
      }
    });

    loadPosts();
  </script>
</body>
</html>
